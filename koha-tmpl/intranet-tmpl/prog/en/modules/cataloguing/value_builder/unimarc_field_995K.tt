<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- Progilone B10 -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>UNIMARC_Field 995K builder</title>
    <script type="text/javascript" src="[% themelang %]/js/pgl-callnumber.js"></script>
    <script type="text/javascript" src="[% themelang %]/lib/jquery/jquery.js"></script>

    <script type="text/javascript">//<![CDATA[
		function load_function() {
			updateDocumentTypePrefix();
			updateAvailableFormatPrefix();
		}

		function upperCase(x) {
			var y = document.getElementById(x).value;
            y = accentsTidy(y).toUpperCase();
            document.getElementById(x).value = y;
		}

		function accentsTidy(x) {
            x = x.replace(/[àáâãäå]/g,"a");
            x = x.replace(/æ/g,"ae");
            x = x.replace(/ç/g,"c");
            x = x.replace(/[èéêë]/g,"e");
            x = x.replace(/[ìíîï]/g,"i");
            x = x.replace(/ñ/g,"n");
            x = x.replace(/[òóôõö]/g,"o");
            x = x.replace(/œ/g,"oe");
            x = x.replace(/[ùúûü]/g,"u");
            x = x.replace(/[ýÿ]/g,"y");
            return x;
        }

	//]]></script>
</head>
<body onload="load_function()">
	<form name="f_pop" action="plugin_launcher.pl">
		<input type="hidden" name="plugin_name" value="unimarc_field_995K.pl" />
		<input type="hidden" name="index" value="[% index %]" />
		<input type="hidden" name="result" value="[% result %]" />

		[% IF (op) %]
			<input type="hidden" name="op" value="cancelOrCheck" />
			<input type="hidden" name="branch" value="[% branch %]" />
			<input type="hidden" name="mention" value="[% mention %]" />
			<input type="hidden" name="type" value="[% type %]" />
			<input type="hidden" name="measures" value="[% measures %]" />
			<input type="hidden" name="format" value="[% format %]" />
			<input type="hidden" name="number" value="[% number %]" />

			<input type="hidden" name="retro" value="[% retro %]" />
			<input type="hidden" name="retroCallnumber" value="[% retroCallnumber %]" />

			[% IF (ruleError) %]
				<div>
				    [% IF (ruleNotActive) %]
					   This callnumber rule is not active.
					[% END %]
					[% IF (ruleNotExist) %]
                        This callnumber rule does not exist.
                    [% END %]
				</div>

				<div>
					<input type="submit" name="cancel" value="Retour"/>
				</div>
			[% ELSE %]

				[% IF (alreadyUsed) %]
					<div>
						There is already an item with this callnumber. Please choose another sequence number.
					</div>
				[% END %]

				<table>
					<tr>
						<td>Store callnumber</td>
						<td><input type="text" name="callnumber" value="[% callnumber %]" readonly="readonly" size="40"/></td>
					</tr>
					[% UNLESS (computedNumber) %]
						<tr>
							<td>Choose sequence number</td>
							<td>
								<input type="text" name="choosenNumber" value="" maxlength="6" size="6"/>
								<input type="hidden" name="mandatory" value="1" />
							</td>
						</tr>
					[% END %]
				</table>

				<div>
					[% IF (computedNumber) %]
						<input type="button" value="OK" onclick="if( checkMandatory() ){report();}"/>
					[% ELSE %]
						<input type="submit" name="check" value="OK" onclick="return checkMandatory();"/>
					[% END %]
					<input type="submit" name="cancel" value="Cancel"/>
				</div>
			[% END %]
		[% ELSE %]
			<input type="hidden" name="op" value="compute" />
			<!-- <input type="hidden" maxlength="5" name="branch" value="[% branch %]" />-->
			<input type="hidden" maxlength="6" name="number" value="[% number %]" />

			<div id="pluginCallnumber" name="pluginCallnumber" [% IF (retro) %]style="display: none;"[% END %] >
				<table>
					<tr>
						<td>Branch *</td>
						<td>
							<select name="branch" size="1">
								[% FOREACH branch IN branch_values_hash %]
									<option value="[% branch.value %]" [% branch.selected %] >[% branch.label %]</option>
								[% END %]
							</select>
							<input type="hidden" name="mandatory" value="1" />
						</td>
					</tr>
					<tr>
						<td>Additional mention</td>
						<td><input id="mention" type="text" maxlength="3" name="mention" value="[% mention %]"
						          onblur="javascript:updateAvailableFormatPrefix();" onkeyup="upperCase(this.id)"/></td>
					</tr>
					<tr>
						<td>Document type prefix *</td>
						<td>
							<select name="type" size="1" onchange="javascript:updateAvailableFormatPrefix();">
								[% FOREACH type IN type_auth_values_hash %]
									<option value="[% type.value %]" [% type.selected %] >[% type.label %]</option>
								[% END %]
							</select>
							<input type="hidden" name="mandatory" value="1" />
						</td>
					</tr>
					<tr>
						<td>Format (accurate measurements)</td>
						<td><input type="text" name="measures" value="[% measures %]" onchange="javascript:updateFormatPrefix();"/></td>
					</tr>
					<tr>
						<td>Format prefix</td>
						<td>
							<select name="format" size="1">
								<option value = ""></option>
								[% FOREACH format IN format_auth_values_hash %]
									<option value="[% format.value %]" [% format.selected %] >[% format.label %]</option>
								[% END %]
							</select>
						</td>
					</tr>
					[% UNLESS (UseAdvancedCallNumberManagement) %]
						<tr>
							<td>Sequence number</td>
							<td><input type="text" name="sequenceNumber" value="[% sequenceNumber %]" /></td>
						</tr>
					[% END %]
				</table>
			</div>

			<br/>
			<div>
				<input type="checkbox" name="retro" id="retro" [% IF (retro) %]checked="checked"[% END %] onclick="toggleVisibility(this, 'retroCallnumber', false);toggleDisplay(this, 'pluginCallnumber', true);toggleDisplay(this, 'disabledRetroCallnumber', true);" />
                <label for="retroc">Retro</label>
				<input type="text" name="disabledRetroCallnumber" size="67" maxlength="255" id="disabledRetroCallnumber" disabled="disabled" [% IF (retro) %]style="display: none;"[% END %] value="[% retroCallnumber %]" />
                <input type="text" name="retroCallnumber" size="67" maxlength="255" id="retroCallnumber" [% UNLESS (retro) %]style="visibility: hidden;"[% END %] value="[% retroCallnumber %]" />
			</div>

			<br/>
			<div>
				<input type="submit" value="OK" onclick="return checkMandatory();"/>
			</div>
		[% END %]
	</form>

	<script type="text/javascript">
		function addOption(element, option, position) {
			if (position != null && position < element.length) {
				var optionAtPostion = element.options[position];
				try {
					element.add(option, optionAtPostion); // standards compliant; doesn't work in IE
				} catch(ex) {
					element.add(option, position); // IE only
				}
			} else {
				try {
					element.add(option, null); // standards compliant; doesn't work in IE
				} catch(ex) {
					element.add(option); // IE only
				}
			}
		}

		function removeOption(element, option) {
			for (var i = 0; i < element.length; i++) {
				if (element.children[i].value == option) {
					optionElement = element.children[i];
					element.remove(i);
					return optionElement;
				}
			}
		}

		function disableAllOptions(element) {
			for (var i = 0; i < element.options.length; i++) {
				element.options[i].style.display = 'none';
			}
		}

		function enableOption(element, optionValue) {
			for (var i = 0; i < element.options.length; i++) {
                if (element.options[i].value == optionValue) {
                    element.options[i].style.display = '';
                }
            }
		}

		function updateDocumentTypePrefix() {
			var MON_option = removeOption(document.f_pop.type, 'MON   ');
			var PER_option = removeOption(document.f_pop.type, 'PER   ');
			addOption(document.f_pop.type, PER_option, 0);
			addOption(document.f_pop.type, MON_option, 0);
		}

		function updateAvailableFormatPrefix() {
			disableAllOptions(document.f_pop.format);

			var mention = document.f_pop.mention;
			var type = document.f_pop.type;
			var measures = document.f_pop.measures;
			var format = document.f_pop.format;
			var old_value = document.f_pop.format.value;

			if (type.value == 'BR    ') {
				measures.disabled = '';
				format.disabled = '';
				enableOption(format, '16   ');
				enableOption(format, '8    ');
				enableOption(format, '4    ');
				enableOption(format, 'Fol  ');
			} else if (type.value == 'MON   ') {
				measures.disabled = '';
				format.disabled = '';
				enableOption(format, '16   ');
				enableOption(format, '8    ');
				enableOption(format, '4    ');
				enableOption(format, 'Fol  ');
				if (mention.value != 'RES') {
					enableOption(format, 'GFol ');
					enableOption(format, 'TIB  ');
				}
			} else if (type.value == 'PER   ') {
				measures.disabled = '';
				format.disabled = '';
				enableOption(format, '8    ');
				enableOption(format, '4    ');
				enableOption(format, 'Fol  ');
				if (mention.value != 'RES') {
					enableOption(format, '16   ');
					enableOption(format, 'GFol ');
				}
			} else if (type.value == 'ARC   ') {
				measures.disabled = '';
				format.disabled = '';
				enableOption(format, 'HF   ');
			} else if (type.value == 'MS    ') {
				measures.disabled = '';
				format.disabled = '';
				enableOption(format, 'HF   ');
			} else {
				measures.value = '';
				measures.disabled = 'disabled';
				format.value = '';
				format.disabled = 'disabled';
			}

			for (var i = 0; i < format.options.length; i++) {
			    if (format.options[i].value == old_value) {
			        if(format.options[i].style.display == "none") {
					document.f_pop.format.value = "";
			        } else {
					document.f_pop.format.value = old_value;
			        }
			    }
			}

			updateFormatPrefix();
		}

		function updateFormatPrefix() {
			if (document.f_pop.measures.value == '') {
				return;
			}

			//if (document.f_pop.type.value == 'TIB') {
			//	return;
			//}

			var measures = parseInt(document.f_pop.measures.value);
			if (isNaN(measures)) {
				return;
			}

			var format = document.f_pop.format;
			if (document.f_pop.mention.value == 'RES') {
				if (measures <= 25) {
					format.value = '16   ';
				} else if (measures > 25 && measures <= 30) {
					format.value = '4    ';
				} else if (measures > 30) {
					format.value = 'Fol  ';
				}
			} else {
				if (measures <= 20) {
					format.value = '16   ';
				} else if (measures > 20 && measures <= 25) {
					format.value = '8    ';
				} else if (measures > 25 && measures <= 30) {
					format.value = '4    ';
				} else if (measures > 30 && measures <= 48) {
					format.value = 'Fol  ';
				} else if (measures > 48) {
					format.value = 'GFol ';
				}
			}
		}

		function checkMandatory() {
			var errors = 0;
			var fields = findSubfieldsWithProperty("mandatory");

			for (var i = 0; i < fields.length; i++) {
				var el = getInputSubfield(fields[i]);
				if (!el.value) {
					errors++;
					var label = fields[i].previousSibling.previousSibling;
					label.style.backgroundColor="#FF0000";
					label.style.fontWeight = "bold";
				} else {
					var label = fields[i].previousSibling.previousSibling;
					label.style.backgroundColor="#FFFFFF";
					label.style.fontWeight = "normal";
				}
			}

			if (errors) {
				return false;
			}
			return true;
		}

		function report() {
		    var doc   = opener.document;
	        var field = doc.getElementById("[% index %]");

	        field.value = document.f_pop.callnumber.value;
	        reportToSubfield(doc, 'K', 'k', document.f_pop.callnumber.value);

			window.close();
			return false;
		}
	</script>
</body>
</html>